const u=["INT","OP","REG","MEM","EOF","KWD","LBL"],c=["LD","PP","PO","JZ","JP","RT","RI","AD","SB","AN","OR","NO","XO","SL","SR"],a=r=>{let e=parseInt(r);return!isNaN(e)&&Number.isInteger(e)};class x{constructor(e){this.expression=e.replaceAll(" ",""),this.pos=0}advance(){this.pos+=1}getNextToken(){if(this.pos>=this.expression.length)return new i("EOF",null);let e=this.expression[this.pos];if(a(e)){let t="";for(;a(e);)t+=e,this.advance(),e=this.expression[this.pos];return new i("INT",parseInt(t))}return this.advance(),new i("OP",e)}tokenize(){let e=[],t=this.getNextToken();for(;t.type!=="EOF";)e.push(t),t=this.getNextToken();return e.push(new i("EOF",null)),e}}class d{constructor(e){this.tokens=e,this.pos=0,this.precedence={"+":10,"-":10,"*":20,"/":20}}peek(){return this.tokens[this.pos]}next(){return this.tokens[this.pos++]}lbp(e){return e.type=="OP"&&this.precedence[e.value]||0}nud(e){if(e.type=="INT")return{type:"atom",value:e.value};if(e.type=="OP"&&e.value=="("){let t=this.parseExpression(0);return this.next(),t}throw new Error("Unexpected token in nud: "+e.value)}led(e,t){if(t.type=="OP"){let s=this.parseExpression(this.lbp(t));return{type:"expr",op:t.value,left:e,right:s}}throw new Error("Unexpected token in led: "+t.value)}parseExpression(e=0){let t=this.next(),s=this.nud(t);for(;e<this.lbp(this.peek());){let n=this.next();s=this.led(s,n)}return s}parse(){return this.parseExpression(0)}}const o=r=>{if(r.type=="atom")return r.value;if(r.type=="expr"){let e=o(r.left),t=o(r.right);switch(r.op){case"+":return e+t;case"-":return e-t;case"*":return e*t;case"/":return e/t;default:throw new Error("Error evalulating AST!")}}},w=r=>{const t=new x(r).tokenize(),n=new d(t).parse();return o(n)},p=50,l=r=>{let e=parseInt(r);return!isNaN(e)&&Number.isInteger(e)},k=r=>"@abcdefghijklmnopqrstuvwxyz".indexOf(r.toLowerCase())!=-1;class i{constructor(e=null,t=null){this.type=e,this.value=t}}class f{constructor(e){this.src=e.trim(),this.tokens={},this.keywords=c,this.pos=0,this.expressions=[];for(let t of u)this.tokens[t]=s=>new i(t,s)}getAddress(){let e="",t=this.src[this.pos+1];for(;l(t);)e+=t,this.advance(),t=this.src[this.pos+1];return parseInt(e)}getMacro(){let e="",t=this.src[this.pos+1],s=p,n=0;for(;t!=";";)if(e+=t,this.advance(),t=this.src[this.pos+1],n++,n>s)throw new Error(`Max expression length (${p}) exceeded. Did you forget a ';'?
${e}`);return e}getLabel(e){return this.labels.map(t=>t.name==e)[0]||null}advance(e=1){this.pos+=e}getNextToken(){let e=new i,t=this.src[this.pos];if(t==" "||t==`
`)return this.advance(),e;if(this.pos>this.src.length-1)e=this.tokens.EOF(null);else if(l(t)){let s="";for(;l(t);)s+=t,t=this.src[this.pos+1],this.advance();e=this.tokens.INT(parseInt(s))}else if(t==":"||t=="#"){let s=this.getAddress();e=t==":"?this.tokens.REG(s):this.tokens.MEM(s)}else if(t=="@"){let s="";for(;k(t)&&(t=this.src[this.pos+1],t!=" ");)s+=t,this.advance();const n=this.getMacro().trim();switch(s){case"expr":let h=w(n);this.expressions.push({expr:n,value:h}),e=this.tokens.INT(h);break;case"label":e=this.tokens.LBL(n);break;default:throw new Error(`Unknown Macro Type: ${s}`)}this.advance(2)}else{let s="";for(;t!=" "&&(s+=t,!(this.pos+1>=this.src.length));)t=this.src[this.pos+1],this.advance();if(this.keywords.indexOf(s)!=-1)e=this.tokens.KWD(s);else throw e=null,new Error(`Unknown Keyword: ${s}`)}return this.advance(),e}tokenize(){let e=new i,t=[];for(;e.type!="EOF"&&(e=this.getNextToken(),!!e);)e.type!=null&&t.push(e);return t}}export{f as Lexer,i as Token};
