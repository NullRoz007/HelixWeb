import{Token as g}from"./lexer-ZeEIXq-y.js";const o={AD:1,SB:2,AN:3,OR:4,NO:5,XO:6,OVERRIDE:7},m={PP:0,PO:0,JZ:115,JP:255,RT:0,RI:239,SL:24,SR:20},i=(a,e)=>{let t="";for(let r=0;r<a;r++)t+="0";return t+=e,"0b"+t.slice(-a)};class b{constructor(e,t){this.name=e,this.pos=t}}class p{constructor(e=""){this.line=e,this.memAddr=0,this.immValue=0,this.immFlag=0,this.aluCtrl=0,this.regAddr=0,this.writeFlag=0,this.clearFlag=0}setRaw(e,t){i(8,e.toString(2)),i(8,t.toString(2)),this.immValue=e,this.memAddr=e,this.immFlag=e&1,this.aluCtrl=t>>5&7,this.regAddr=t>>2&7,this.writeFlag=t>>1&1,this.clearFlag=t&1}build(){let e=(this.immFlag?this.immValue:this.memAddr)<<1|this.immFlag,t=0;return t|=this.aluCtrl<<5,t|=this.regAddr<<2,t|=this.writeFlag<<1,t|=this.clearFlag,[i(8,e.toString(2)),i(8,t.toString(2))]}toString(){let e=this.build(),t=`Line:		${this.line}
Instruction:	`,r=i(7,this.immValue.toString(2)),s=i(7,this.memAddr.toString(2)),l=i(3,this.aluCtrl.toString(2)),d=i(3,this.regAddr.toString(2));return t+=this.immFlag?`Imm(${r})`:`MemAddr(${s})`,t+=`, AluCtrl(${l})`,t+=`, RegAddr(${d})`,t+=`, Flags(imm = 0b${this.immFlag}, wr = 0b${this.writeFlag}, cl = 0b${this.clearFlag})`,t+=`
Raw:		[${e[0]}, ${e[1]}]`,t}}class c{constructor(e){this.tokens=e,this.pos=0,this.instructions=[],this.labels=[]}lookAhead(e=1){let t=[],r=this.pos+1;if(this.pos+e<this.tokens.length)for(let s=0;s<e;s++){let l=this.tokens[r+s];t.push(l)}return t}advance(e=1){this.pos+=e}parseLoadKeyword(e,t,r){if(r=="INT")e.immFlag=1,e.aluCtrl=o.OVERRIDE,e.immValue=t;else if(r=="REG")e.immFlag=0,e.regAddr=t;else throw new Error(`Unsupported valueType!"
        value:	${t}
        type: 	${type}
      `)}parseKeyword(e){let t=new p,r=this.lookAhead(2),s=r[0].value,l=r[0].type,d=r[1].value,u=r[1].type,n=`${e.value}: `,h=null;if(l=="REG")t.regAddr=s;else if(l=="MEM")t.memAddr=s;else if(l=="LBL"){if(h=this.getLabel(s),!h)throw new Error(`Unknown label: ${s}`)}else if(l!="INT")throw new Error("Unsupported addressType!");if(o[e.value]!==void 0)n+=`${l}(${s})`,t.aluCtrl=o[e.value],this.advance();else if(m[e.value]!==void 0)n+=`${l}(${s}) - S`,l=="LBL"&&h&&(s=h.pos),t.setRaw(s,m[e.value]),this.advance();else if(e.value=="LD")n+=`${l}(${s}) <- ${u}(${d})`,this.parseLoadKeyword(t,d,u),t.writeFlag=1,this.advance(2);else throw new Error(`Unknown Keyword: '${e.value}'`);return t.line=n,t}getLabel(e){return this.labels.filter(t=>t.name==e)[0]}getNextToken(){return this.tokens[this.pos]}parse(){let e=new g,t=0;for(;e.type!="EOF";)switch(e=this.getNextToken(),e.type){case"KWD":let r=this.parseKeyword(e);this.instructions.push(r),this.advance(),t++;break;case"LBL":let s=e.value;this.getLabel(s)||this.labels.push(new b(s,t)),this.advance();break;case"EOF":break;default:throw new Error(`Unknown Token Type: ${e.type}`)}}}export{p as Instruction,c as Parser};
